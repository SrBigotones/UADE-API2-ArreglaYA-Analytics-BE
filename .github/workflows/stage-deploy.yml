name: Deploy to Stage

on:
  push:
    branches: [develop]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      
      # Install dependencies and build TypeScript
      - run: npm ci
      - run: npm run build

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_STAGE }}
          aws-region: ${{ vars.AWS_REGION }}

      - uses: aws-actions/setup-sam@v2
      
      # Delete the stack if it exists in ROLLBACK_COMPLETE state
      - name: Delete failed stack
        run: |
          if aws cloudformation describe-stacks --stack-name arreglaya-analytics-be-stage 2>&1 | grep -q 'ROLLBACK_COMPLETE'; then
            aws cloudformation delete-stack --stack-name arreglaya-analytics-be-stage
            aws cloudformation wait stack-delete-complete --stack-name arreglaya-analytics-be-stage
          fi
        continue-on-error: true
      
      - run: sam build --use-container
      
      # Deploy with secure parameters
      - name: Get SSM Parameters
        id: ssm
        run: |
          {
            # Desactivar el echo de comandos
            set +x
            
            # Funci칩n para a침adir secreto a GITHUB_ENV de forma segura
            add_secret() {
              local name=$1
              local value=$2
              echo "$name<<EOF" >> $GITHUB_ENV
              echo "$value" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            }
            
            # Obtener y guardar par치metros como secretos
            add_secret "DB_HOST" "$(aws ssm get-parameter --name '/arreglaya/analytics/stage/db/host' --with-decryption --query 'Parameter.Value' --output text)"
            add_secret "DB_USERNAME" "$(aws ssm get-parameter --name '/arreglaya/analytics/stage/db/username' --with-decryption --query 'Parameter.Value' --output text)"
            add_secret "DB_PASSWORD" "$(aws ssm get-parameter --name '/arreglaya/analytics/stage/db/password' --with-decryption --query 'Parameter.Value' --output text)"
            add_secret "DB_NAME" "$(aws ssm get-parameter --name '/arreglaya/analytics/stage/db/name' --with-decryption --query 'Parameter.Value' --output text)"
            add_secret "USERS_API_BASE_URL" "$(aws ssm get-parameter --name '/arreglaya/analytics/stage/db/users-api-base-url' --with-decryption --query 'Parameter.Value' --output text)"
            add_secret "CORE_HUB_API_KEY" "$(aws ssm get-parameter --name '/arreglaya/analytics/stage/db/core-hub-api-key' --with-decryption --query 'Parameter.Value' --output text)"
            add_secret "CORE_HUB_URL" "$(aws ssm get-parameter --name '/arreglaya/analytics/stage/db/core-hub-url' --with-decryption --query 'Parameter.Value' --output text)"
            add_secret "WEBHOOK_SECRET" "$(aws ssm get-parameter --name '/arreglaya/analytics/stage/db/webhook-secret' --with-decryption --query 'Parameter.Value' --output text)"
            add_secret "WEBHOOK_BASE_URL" "$(aws ssm get-parameter --name '/arreglaya/analytics/stage/db/webhook-base-url' --with-decryption --query 'Parameter.Value' --output text)"
            
            echo "::debug::SSM parameters retrieved successfully"
          } 2>/dev/null # Suprimir errores en la salida

      - name: Deploy SAM application
        run: |
          set +x # Desactivar echo de comandos
          
          # Funci칩n para desenmascarar valores
          unmask_value() {
            echo "${1#::add-mask::}"
          }
          
          # Desenmascarar valores antes del deploy
          DB_HOST_CLEAN=$(unmask_value "$DB_HOST")
          DB_USERNAME_CLEAN=$(unmask_value "$DB_USERNAME")
          DB_PASSWORD_CLEAN=$(unmask_value "$DB_PASSWORD")
          DB_NAME_CLEAN=$(unmask_value "$DB_NAME")
          USERS_API_BASE_URL_CLEAN=$(unmask_value "$USERS_API_BASE_URL")
          CORE_HUB_API_KEY_CLEAN=$(unmask_value "$CORE_HUB_API_KEY")
          CORE_HUB_URL_CLEAN=$(unmask_value "$CORE_HUB_URL")
          WEBHOOK_SECRET_CLEAN=$(unmask_value "$WEBHOOK_SECRET")
          WEBHOOK_BASE_URL_CLEAN=$(unmask_value "$WEBHOOK_BASE_URL")
          
          # Add masks for sensitive values (ahora con los valores limpios)
          echo "::add-mask::$DB_HOST_CLEAN"
          echo "::add-mask::$DB_USERNAME_CLEAN"
          echo "::add-mask::$DB_PASSWORD_CLEAN"
          echo "::add-mask::$DB_NAME_CLEAN"
          echo "::add-mask::$USERS_API_BASE_URL_CLEAN"
          echo "::add-mask::$CORE_HUB_API_KEY_CLEAN"
          echo "::add-mask::$CORE_HUB_URL_CLEAN"
          echo "::add-mask::$WEBHOOK_SECRET_CLEAN"
          echo "::add-mask::$WEBHOOK_BASE_URL_CLEAN"
          
          echo "::debug::Starting SAM deployment..."
          
          sam deploy \
            --stack-name arreglaya-analytics-be-stage \
            --no-confirm-changeset \
            --capabilities CAPABILITY_IAM \
            --resolve-s3 \
            --parameter-overrides \
            Stage=stage \
            DBHost="$DB_HOST_CLEAN" \
            DBUsername="$DB_USERNAME_CLEAN" \
            DBPassword="$DB_PASSWORD_CLEAN" \
            DBName="$DB_NAME_CLEAN" \
            UsersApiBaseUrl="$USERS_API_BASE_URL_CLEAN" \
            CoreHubApiKey="$CORE_HUB_API_KEY_CLEAN" \
            CoreHubUrl="$CORE_HUB_URL_CLEAN" \
            WebhookSecret="$WEBHOOK_SECRET_CLEAN" \
            WebhookBaseUrl="$WEBHOOK_BASE_URL_CLEAN"
          
          echo "::debug::SAM deployment completed"